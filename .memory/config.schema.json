{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/anthropics/ef-memory-for-claude/config.schema.json",
  "title": "EF Memory Configuration",
  "description": "Configuration schema for EF Memory for Claude",
  "type": "object",
  "required": [
    "version",
    "paths",
    "verify",
    "search"
  ],
  "properties": {
    "$schema": {
      "type": "string",
      "description": "JSON Schema reference"
    },
    "version": {
      "type": "string",
      "pattern": "^[0-9]+\\.[0-9]+$",
      "description": "Configuration version"
    },
    "preset": {
      "type": "string",
      "enum": [
        "minimal",
        "standard",
        "full"
      ],
      "description": "Configuration preset. 'minimal' disables embeddings, reasoning, evolution; 'standard' enables core features with auto-harvest; 'full' enables all features including LLM reasoning. Individual settings override preset defaults."
    },
    "efm_version": {
      "type": "string",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$",
      "description": "Installed EFM version. Written by init/upgrade, read by startup check."
    },
    "hooks": {
      "type": "object",
      "description": "Hook enablement toggles",
      "properties": {
        "pre_edit_search_enabled": {
          "type": "boolean",
          "default": true,
          "description": "Enable the pre-edit memory search hook. Set to false to disable search-before-edit."
        }
      },
      "additionalProperties": false
    },
    "paths": {
      "type": "object",
      "description": "Project path mappings",
      "properties": {
        "CODE_ROOTS": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Main source code directories"
        },
        "FEATURE_ROOTS": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Feature engineering directories"
        },
        "LABEL_ROOTS": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Label generation directories"
        },
        "DEPLOYMENT_ROOTS": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Deployment/production directories"
        },
        "DOCS_ROOT": {
          "type": "string",
          "description": "Documentation root directory"
        },
        "INCIDENTS_FILE": {
          "type": "string",
          "description": "Path to incidents log file (optional, legacy — use doc_roots for general document scanning)"
        }
      },
      "additionalProperties": {
        "oneOf": [
          {
            "type": "string"
          },
          {
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        ]
      }
    },
    "verify": {
      "type": "object",
      "required": [
        "rulesets"
      ],
      "properties": {
        "rulesets": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of ruleset file paths to load"
        },
        "fail_on_missing_path": {
          "type": "boolean",
          "default": false,
          "description": "Whether to FAIL or WARN when paths are missing"
        },
        "staleness_threshold_days": {
          "type": "integer",
          "default": 90,
          "description": "Days before an entry is considered stale"
        },
        "allowed_commands": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Commands allowed in verify field (read-only only)"
        }
      }
    },
    "search": {
      "type": "object",
      "properties": {
        "max_results": {
          "type": "integer",
          "default": 5,
          "maximum": 10,
          "description": "Maximum entries to return per search"
        },
        "priority": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "hard",
              "soft"
            ]
          },
          "description": "Priority order for classification"
        },
        "severity_order": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "S1",
              "S2",
              "S3"
            ]
          },
          "description": "Priority order for severity"
        }
      }
    },
    "import": {
      "type": "object",
      "description": "Import configuration. Supports any structured document — incidents, decisions, architecture docs, runbooks, code comments, and more.",
      "properties": {
        "supported_sources": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": [
            "*.md",
            "*.py",
            "*.ts",
            "*.js",
            "*.go"
          ],
          "description": "File patterns supported for import (glob-style). Any document with extractable knowledge can be imported."
        },
        "doc_roots": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": [
            "docs/"
          ],
          "description": "Default document roots to scan for importable content"
        },
        "require_line_numbers": {
          "type": "boolean",
          "default": false,
          "description": "Whether to require line numbers in sources. When false, heading anchors are acceptable."
        }
      }
    },
    "embedding": {
      "type": "object",
      "description": "Embedding layer configuration (Phase II). Optional — system works without it.",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false,
          "description": "Enable the embedding layer. When false, system operates in Phase I mode."
        },
        "provider": {
          "type": "string",
          "enum": [
            "gemini",
            "openai",
            "ollama"
          ],
          "default": "gemini",
          "description": "Primary embedding provider"
        },
        "fallback": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Fallback providers if primary fails"
        },
        "providers": {
          "type": "object",
          "description": "Per-provider configuration",
          "properties": {
            "gemini": {
              "type": "object",
              "properties": {
                "model": {
                  "type": "string",
                  "default": "gemini-embedding-001"
                },
                "dimensions": {
                  "type": "integer",
                  "default": 768
                },
                "api_key_env": {
                  "type": "string",
                  "default": "GOOGLE_API_KEY"
                }
              }
            },
            "openai": {
              "type": "object",
              "properties": {
                "model": {
                  "type": "string",
                  "default": "text-embedding-3-small"
                },
                "dimensions": {
                  "type": "integer",
                  "default": 1536
                },
                "api_key_env": {
                  "type": "string",
                  "default": "OPENAI_API_KEY"
                }
              }
            },
            "ollama": {
              "type": "object",
              "properties": {
                "model": {
                  "type": "string",
                  "default": "nomic-embed-text"
                },
                "dimensions": {
                  "type": "integer",
                  "default": 768
                },
                "host": {
                  "type": "string",
                  "default": "http://localhost:11434"
                }
              }
            }
          }
        },
        "search": {
          "type": "object",
          "description": "Hybrid search weight configuration",
          "properties": {
            "bm25_weight": {
              "type": "number",
              "default": 0.4,
              "minimum": 0,
              "maximum": 1
            },
            "vector_weight": {
              "type": "number",
              "default": 0.6,
              "minimum": 0,
              "maximum": 1
            },
            "hard_s1_boost": {
              "type": "number",
              "default": 0.15
            },
            "hard_s2_boost": {
              "type": "number",
              "default": 0.1
            },
            "hard_s3_boost": {
              "type": "number",
              "default": 0.05
            },
            "min_score": {
              "type": "number",
              "default": 0.1
            }
          }
        },
        "sync": {
          "type": "object",
          "properties": {
            "auto_on_save": {
              "type": "boolean",
              "default": true
            },
            "batch_size": {
              "type": "integer",
              "default": 20,
              "minimum": 1,
              "maximum": 100
            }
          }
        },
        "storage": {
          "type": "object",
          "properties": {
            "db_path": {
              "type": "string",
              "default": ".memory/vectors.db"
            }
          }
        },
        "dedup_threshold": {
          "type": "number",
          "default": 0.92,
          "minimum": 0.5,
          "maximum": 1.0,
          "description": "Cosine similarity threshold for duplicate detection"
        }
      }
    },
    "automation": {
      "type": "object",
      "description": "M4 Automation Engine configuration",
      "properties": {
        "human_review_required": {
          "type": "boolean",
          "default": true,
          "description": "When true (default), /memory-save and /memory-import require explicit human approval before writing to events.jsonl. When false, Claude may directly write entries after extraction — still validates schema, but skips the confirmation step. Toggle via config or tell Claude: 'turn off memory review'."
        },
        "startup_check": {
          "type": "boolean",
          "default": true,
          "description": "Enable startup health check"
        },
        "pipeline_steps": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "sync_embeddings",
              "generate_rules",
              "evolution_check",
              "reasoning_check",
              "harvest_check"
            ]
          },
          "default": [
            "sync_embeddings",
            "generate_rules"
          ],
          "description": "Ordered pipeline steps to run"
        },
        "pipeline_after_approve": {
          "type": "boolean",
          "default": false,
          "description": "Auto-run pipeline after draft approval"
        },
        "dedup_check_on_capture": {
          "type": "boolean",
          "default": true,
          "description": "Check for duplicates when creating drafts"
        },
        "dedup_threshold": {
          "type": "number",
          "default": 0.85,
          "minimum": 0.5,
          "maximum": 1.0,
          "description": "Text similarity threshold for duplicate detection"
        },
        "startup_source_sample_size": {
          "type": "integer",
          "default": 10,
          "minimum": 1,
          "maximum": 50,
          "description": "Number of entries to spot-check during startup"
        },
        "auto_persist_confidence_threshold": {
          "type": [
            "number",
            "null"
          ],
          "default": null,
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "When set, entries with extraction confidence >= threshold auto-persist to events.jsonl; entries below threshold are routed to drafts. When null (default), uses human_review_required boolean instead."
        },
        "pipeline_max_retries": {
          "type": "integer",
          "default": 2,
          "minimum": 0,
          "maximum": 5,
          "description": "Maximum retry attempts per pipeline step on transient failure"
        },
        "pipeline_retry_delay": {
          "type": "number",
          "default": 1.0,
          "minimum": 0.1,
          "maximum": 10.0,
          "description": "Base delay in seconds between retries (exponential backoff)"
        },
        "min_content_length": {
          "type": "integer",
          "default": 15,
          "minimum": 5,
          "maximum": 100,
          "description": "Minimum title length for auto-harvested entries to pass quality gate"
        }
      }
    },
    "evolution": {
      "type": "object",
      "description": "M5 Memory Evolution configuration",
      "properties": {
        "confidence_half_life_days": {
          "type": "integer",
          "default": 120,
          "minimum": 7,
          "maximum": 365,
          "description": "Half-life in days for confidence decay model"
        },
        "deprecation_confidence_threshold": {
          "type": "number",
          "default": 0.3,
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Entries below this confidence are deprecation candidates"
        },
        "merge_auto_suggest": {
          "type": "boolean",
          "default": true,
          "description": "Auto-suggest merges from duplicate groups"
        },
        "incremental_checkpoint": {
          "type": "boolean",
          "default": true,
          "description": "Cache evolution results and skip recomputation when the set of active entry IDs is unchanged. Set to false to always do full analysis."
        },
        "source_quality_weights": {
          "type": "object",
          "description": "Quality weights by source type for confidence scoring",
          "properties": {
            "code": {
              "type": "number",
              "default": 1.0
            },
            "function": {
              "type": "number",
              "default": 1.0
            },
            "markdown": {
              "type": "number",
              "default": 0.7
            },
            "commit": {
              "type": "number",
              "default": 0.6
            },
            "pr": {
              "type": "number",
              "default": 0.5
            },
            "unknown": {
              "type": "number",
              "default": 0.3
            }
          }
        },
        "confidence_weights": {
          "type": "object",
          "description": "Component weights for confidence calculation (must sum to 1.0)",
          "properties": {
            "source_quality": {
              "type": "number",
              "default": 0.3
            },
            "age_factor": {
              "type": "number",
              "default": 0.3
            },
            "verification_boost": {
              "type": "number",
              "default": 0.15
            },
            "source_validity": {
              "type": "number",
              "default": 0.25
            }
          }
        }
      }
    },
    "reasoning": {
      "type": "object",
      "description": "M6 LLM Reasoning Layer configuration. Optional — system works without it (heuristic-only mode).",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false,
          "description": "Enable LLM reasoning layer. When false, reasoning functions use heuristic-only mode."
        },
        "provider": {
          "type": "string",
          "enum": [
            "anthropic",
            "openai",
            "gemini",
            "ollama"
          ],
          "default": "anthropic",
          "description": "Primary LLM provider for reasoning"
        },
        "fallback": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "anthropic",
              "openai",
              "gemini",
              "ollama"
            ]
          },
          "description": "Fallback LLM providers if primary fails"
        },
        "providers": {
          "type": "object",
          "description": "Per-provider LLM configuration",
          "properties": {
            "anthropic": {
              "type": "object",
              "properties": {
                "model": {
                  "type": "string",
                  "default": "claude-sonnet-4-20250514"
                },
                "api_key_env": {
                  "type": "string",
                  "default": "ANTHROPIC_API_KEY"
                }
              }
            },
            "openai": {
              "type": "object",
              "properties": {
                "model": {
                  "type": "string",
                  "default": "gpt-4o-mini"
                },
                "api_key_env": {
                  "type": "string",
                  "default": "OPENAI_API_KEY"
                }
              }
            },
            "gemini": {
              "type": "object",
              "properties": {
                "model": {
                  "type": "string",
                  "default": "gemini-2.0-flash"
                },
                "api_key_env": {
                  "type": "string",
                  "default": "GOOGLE_API_KEY"
                }
              }
            },
            "ollama": {
              "type": "object",
              "properties": {
                "model": {
                  "type": "string",
                  "default": "llama3.1"
                },
                "host": {
                  "type": "string",
                  "default": "http://localhost:11434"
                }
              }
            }
          }
        },
        "max_tokens": {
          "type": "integer",
          "default": 4096,
          "minimum": 256,
          "maximum": 32768,
          "description": "Maximum output tokens per LLM call"
        },
        "correlation_threshold": {
          "type": "integer",
          "default": 2,
          "minimum": 1,
          "maximum": 10,
          "description": "Minimum tag overlap count to consider entries correlated"
        },
        "contradiction_detection": {
          "type": "boolean",
          "default": true,
          "description": "Enable contradiction detection in reasoning analysis"
        },
        "synthesis_min_group_size": {
          "type": "integer",
          "default": 3,
          "minimum": 2,
          "maximum": 10,
          "description": "Minimum entries in a cluster to suggest synthesis"
        },
        "token_budget": {
          "type": "integer",
          "default": 16000,
          "minimum": 1000,
          "maximum": 128000,
          "description": "Total input character budget for LLM prompts (controls entry serialization truncation)"
        }
      }
    },
    "scan": {
      "type": "object",
      "description": "Document scanning configuration for /memory-scan batch import",
      "properties": {
        "auto_scan_on_init": {
          "type": "boolean",
          "default": true,
          "description": "When true, /memory-init automatically runs document discovery and offers to import. When false, only shows advisory suggestions."
        },
        "exclude_patterns": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": [
            "**/node_modules/**",
            "**/.git/**",
            "**/venv/**",
            "**/__pycache__/**",
            "**/.memory/**"
          ],
          "description": "Glob patterns to exclude from scanning"
        },
        "max_documents": {
          "type": "integer",
          "default": 20,
          "minimum": 1,
          "maximum": 100,
          "description": "Maximum documents per scan session"
        },
        "relevance_keywords": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Keywords used for relevance scoring in document content sampling"
        },
        "high_value_filenames": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Filenames that receive a bonus relevance score"
        }
      }
    },
    "compaction": {
      "type": "object",
      "description": "M11 Compaction and time-sharded archive configuration",
      "properties": {
        "auto_suggest_threshold": {
          "type": "number",
          "default": 2.0,
          "minimum": 1.1,
          "maximum": 10.0,
          "description": "Waste ratio (total_lines / active_entries) above which compaction is suggested and auto-triggered on stop"
        },
        "archive_dir": {
          "type": "string",
          "default": ".memory/archive",
          "description": "Directory for time-sharded archive files"
        },
        "sort_output": {
          "type": "boolean",
          "default": true,
          "description": "Sort compacted entries by created_at in the hot file"
        }
      }
    },
    "v3": {
      "type": "object",
      "description": "V3 Auto-Startup and Working Memory configuration",
      "properties": {
        "auto_startup": {
          "type": "boolean",
          "default": true,
          "description": "Enable auto-startup file generation via /memory-init"
        },
        "working_memory_dir": {
          "type": "string",
          "default": ".memory/working",
          "description": "Directory for working memory session files (gitignored)"
        },
        "harvest_on_compact": {
          "type": "boolean",
          "default": true,
          "description": "Prompt memory harvest before context compaction"
        },
        "prefill_on_plan_start": {
          "type": "boolean",
          "default": true,
          "description": "Pre-fill findings.md with relevant EF Memory entries when starting a plan"
        },
        "max_prefill_entries": {
          "type": "integer",
          "default": 5,
          "minimum": 1,
          "maximum": 20,
          "description": "Maximum memory entries to inject into findings.md on plan start"
        },
        "session_recovery": {
          "type": "boolean",
          "default": true,
          "description": "Detect and report stale working memory sessions at startup"
        },
        "auto_start_on_plan": {
          "type": "boolean",
          "default": true,
          "description": "Automatically start working memory session when entering plan mode"
        },
        "auto_harvest_on_stop": {
          "type": "boolean",
          "default": true,
          "description": "Automatically harvest, persist, and clear working memory session on stop. When false, blocks with reminder instead."
        },
        "auto_draft_from_conversation": {
          "type": "boolean",
          "default": true,
          "description": "Scan conversation transcript for memory-worthy patterns (LESSON, CONSTRAINT, DECISION, etc.) on stop and create drafts in .memory/drafts/. Drafts require manual review via /memory-save. Only activates when no working memory session exists."
        },
        "draft_auto_expire_days": {
          "type": "integer",
          "default": 7,
          "minimum": 0,
          "maximum": 365,
          "description": "Automatically delete drafts older than this many days during startup. Set to 0 to disable auto-expire (full manual control)."
        },
        "require_complete_for_harvest": {
          "type": "boolean",
          "default": false,
          "description": "When true, only sessions with all phases marked [DONE] auto-persist to events.jsonl. Incomplete sessions route all entries to drafts instead."
        }
      }
    }
  }
}
