{
  "version": "1.0",
  "layer": 1,
  "name": "ml",
  "description": "Machine learning verification rules. Checks for data leakage and preprocessing issues.",

  "rules": [
    {
      "id": "ml-001",
      "name": "data-split-present",
      "type": "static-grep",
      "description": "Training code should have proper train/test split",
      "command_template": "echo '[data-split] Checking for split patterns in ${paths.PIPELINE_ROOTS}'; for dir in ${paths.PIPELINE_ROOTS}; do if [ -d \"$dir\" ]; then grep -RInE 'train_test_split|TimeSeriesSplit|KFold|StratifiedKFold' \"$dir\" 2>/dev/null | head -n 30; fi; done; echo 'Done. If no splits found, verify data separation method.'",
      "severity": "WARN"
    },
    {
      "id": "ml-002",
      "name": "scaling-order-check",
      "type": "static-grep",
      "description": "Scaling/normalization should happen after split, not before",
      "command_template": "echo '[scaling] Checking for scaler usage in ${paths.PIPELINE_ROOTS}'; for dir in ${paths.PIPELINE_ROOTS}; do if [ -d \"$dir\" ]; then grep -RInE 'fit_transform|StandardScaler|MinMaxScaler|RobustScaler' \"$dir\" 2>/dev/null | head -n 30; fi; done; echo 'Done. Verify scalers are fit ONLY on training data.'",
      "severity": "WARN",
      "note": "This flags scaler usage for review. Ensure fit() is on train only."
    },
    {
      "id": "ml-003",
      "name": "feature-consistency",
      "type": "static-grep",
      "description": "Feature transformations should be consistent across environments",
      "command_template": "echo '[features] Checking feature definitions in ${paths.FEATURE_ROOTS}'; for dir in ${paths.FEATURE_ROOTS}; do if [ -d \"$dir\" ]; then grep -RIhE 'def (transform|extract|compute)' \"$dir\" 2>/dev/null | head -n 30; fi; done; echo 'Done. Feature definitions should match prod.'",
      "severity": "WARN"
    }
  ]
}
